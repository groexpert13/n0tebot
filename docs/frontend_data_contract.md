**Цель**
- Объяснить фронтенду, какие поля в БД уже заполняет бот/бекенд, а какие ожидаются от фронта. Основано на текущей схеме (`db.md`) и коде бота.

**Таблицы**
- **`app_users`**: профиль и состояние пользователя телеграма + веб-настройки.
- **`notes`**: пользовательские заметки.

**`app_users`**
- **Создает/обновляет бекенд**: см. `app/db_users.py:38`, `app/handlers/start.py:66`.
  - **`tg_user_id`**: ID из Telegram; ключ для поиска/апсерта.
  - **`tg_username/first_name/last_name`**: из профиля Telegram.
  - **`tg_language_code`**: язык клиента Telegram, если есть.
  - **`tg_is_premium`**: признак Telegram Premium, если есть.
  - **`last_platform`**: значение `"telegram-bot"` при визите через бота.
  - **`last_visit_at`**: время последнего визита (UTC, ISO8601).
  - **`visits_count`**: инкремент при каждом `/start`.
  - **`subscription_status`**: при создании — `"none"`.
  - **`timezone`**: при первом создании — `"UTC"` (дефолт).
  - **`created_at/updated_at`**: ставит БД/бекенд при апсерте.
- **Язык веб-интерфейса**: см. `app/db_users.py:74`, вызывается при выборе языка в боте `app/handlers/start.py:88`.
  - **`web_language_code`**: `en|uk|ru` — записывает бекенд.
  - **`language_confirmed_at`**: время подтверждения языка — пишет бекенд.
- **Принятие приватности**: см. `app/db_users.py:100`, вызывается `app/handlers/start.py:109`.
  - **`privacy_accepted`**: `true` — устанавливает бекенд.
  - **`privacy_accepted_at`**: время принятия — пишет бекенд.
- **Что может/должен делать фронт**:
  - **Читать** все вышеперечисленное для настройки UI/локализации/гейтинга.
  - **Обновлять при необходимости**: `timezone` (строка TZ, напр. `Europe/Kyiv`) и/или `utc_offset_minutes` (смещение клиента), если фронт знает локальную таймзону пользователя.
  - **Не трогать**: счетчики/метрики `text_tokens_used_total`, `text_generations_total`, `audio_minutes_total`, `audio_generations_total`, `stars_spent_total` — зарезервированы под логику сервиса.

**`notes`**
- **Назначение**: хранение заметок пользователя (дневные записи).
- **Что должен прислать фронт при создании**:
  - **`user_id`**: UUID из `app_users.id` для текущего пользователя.
  - **`d`**: дата заметки в формате `YYYY-MM-DD` (локальный день пользователя).
  - **`content`**: текст заметки (обязательный).
  - **`title`**: опционально, заголовок заметки.
  - **`source`**: можно опустить — по умолчанию `"web"`.
- **Что ставит БД/сервер**:
  - **`id`**: UUID — генерируется БД.
  - **`created_at`**: время создания — БД.
  - **`updated_at`**: дефолт — БД при вставке.
- **Обновления и удаление**:
  - **Редактирование**: при изменении фронт должен обновить `updated_at` текущим временем (т.к. триггера авто-обновления нет в схеме).
  - **Мягкое удаление**: ставить `deleted_at` текущим временем вместо физического удаления; для восстановления — обнулять `deleted_at`.

**Как фронту получить `user_id`**
- На открытии WebApp Telegram предоставляет `initDataUnsafe.user.id` — это `tg_user_id`.
- Бекенд уже умеет создавать/обновлять пользователя по `tg_user_id` при `/start` и при выборах в боте. Для фронта нужен быстрый способ получить `app_users.id`:
  - Рекомендация: добавить легкий эндпоинт «resolve-user» (по `tg_user_id`) → возвращает `{ id, web_language_code, timezone, privacy_accepted }`.
  - Альтернатива (если прямой доступ к PostgREST/Supabase): один селект по `app_users` с фильтром `tg_user_id` и последующим чтением `id`.

**Контрольные точки для фронта**
- **Локализация**: показывать UI на основе `web_language_code`; fallback на `tg_language_code` или `en`.
- **Приватность**: если `privacy_accepted=false`, ограничивать функциональность/просить подтвердить в боте.
- **Дата заметки**: вычислять `d` в локальной таймзоне пользователя (`timezone` или `utc_offset_minutes`).
- **Фильтрация заметок**: выбирать только `deleted_at IS NULL`.

**Минимальные контрактные структуры**
- Создание заметки (frontend → БД/бекенд):
  - `{ user_id: UUID, d: 'YYYY-MM-DD', content: string, title?: string, source?: 'web' }`
- Обновление заметки:
  - `{ title?: string, content?: string, updated_at: now() }`
- Мягкое удаление заметки:
  - `{ deleted_at: now() }`

**Ссылки на код**
- `app/db_users.py:38` — апсерт визита и заполнение полей профиля.
- `app/db_users.py:74` — установка языка веб-интерфейса.
- `app/db_users.py:100` — фиксация согласия с приватностью.
- `app/handlers/start.py:66` — вызов апсерта при `/start`.
- `app/handlers/start.py:88` — запись выбранного языка.
- `app/handlers/start.py:109` — запись принятия приватности.

**Что осталось фронту**
- Реализовать получение `user_id` и работу с таблицей `notes` (create/update/soft-delete, выборки с `deleted_at IS NULL`).
- Обновлять `timezone`/`utc_offset_minutes` при наличии данных клиента.
- Следовать ограничениям типов/nullable из `db.md` при валидации форм.

